<main class="container">
  <section class="item-header">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h1><%= @item.name %></h1>
      <% if @item.user == current_user %>

        <%= link_to "Modifier l'objet", edit_item_path(@item), class: "btn btn-outline-secondary", style: "border-radius: 0.5rem;"  %>
      <% end %>

    </div>
    <div class="meta"></div>
    <% if @item.reviews.any? %>
      <% total_rating = @item.reviews.sum(:rating) %>
      <% average_rating = total_rating / @item.reviews.count.to_f if @item.reviews.count > 0 %>
      <p>
        ‚≠ê <strong><%= average_rating.round(1) %></strong>
        ¬∑ <a href="#reviews"><%= @item.reviews.count %> commentaires</a>
        ¬∑ <span> ü•á Supervendeur
          ¬∑ <a href="#"><%= @item.user.address %></a>
        </span>
      </p>
    <% end %>
  </section>

  <%# IMAGE GALLERY %>
  <% if @item.image.attached? %>
    <div class="gallery">
      <div class="">
        <%= cl_image_tag @item.image.key, class: "main-image object-fit-cover w-100" %>
      </div>
      <%# <div class="main-image"><img src="nimbus-main.jpg" alt="nimbus" /></div> %>
      <div class="thumbnails col-5">
        <%= cl_image_tag @item.image.key, class: ""  %>
        <%= cl_image_tag @item.image.key, class: "" %>
        <%= cl_image_tag @item.image.key, class: "" %>
        <%= cl_image_tag @item.image.key, class: "" %>
      </div>
    </div>
  <% end %>

  <%# DESCRIPTION %>
  <div class="container2">
    <section class="item-info">
      <div class="d-flex justify-content-between align-items-center">
        <!-- Partie gauche : description et note -->
        <div>
          <h2><%= @item.description %></h2>
          <% if @item.reviews.any? %>
            <% total_rating = @item.reviews.sum(:rating) %>
            <% average_rating = total_rating / @item.reviews.count.to_f if @item.reviews.count > 0 %>
          <% end %>
        </div>
        <!-- Partie droite : image utilisateur -->
        <div>
            <% if @item.user.image.present? %>
            <%= link_to user_profile_path(@item.user) do %>
              <img src="<%= @item.user.image %>" alt="Photo de <%= @item.user.name %>" class="rounded-circle" width="80" height="80">
            <% end %>
          <% else %>
            <img src="/assets/default-avatar.png" alt="Avatar par d√©faut" class="rounded-circle" width="80" height="80">
          <% end %>
        </div>
      </div>

      <div class="info-box">
        ü™Ñ <%= @item.category.capitalize %> de <strong>niveau <%= @item.power %></strong>
      </div>
      <% if @item.category == "Chaudron" %>
        <div class="info-box">
          ‚ú® Peut aussi servir √† faire une excellente soupe aux orties (avec ou sans sortil√®ges).
        </div>
      <% elsif @item.category == "Balais" %>
        <div class="info-box">
          ‚ú® Peut aussi servir √† enlever la poussi√®re
        </div>
      <% elsif @item.category == "Baguette" %>
        <div class="info-box">
          ‚ú® Peut aussi servir √† m√©langer le caf√©‚Ä¶ mais attention aux explosions.
        </div>
      <% elsif @item.category == "Amulette" %>
        <div class="info-box">
          ‚ú® Prot√®ge contre les mal√©dictions‚Ä¶ et les mauvais rencards.
        </div>
      <% elsif @item.category == "Cape" %>
        <div class="info-box">
          ‚ú® Peut aussi cacher une tenue douteuse en cas d'urgence fashion.
        </div>
      <% else %>
        <div class="info-box">
          ‚ú® marche po
        </div>
      <% end %>

      <%# DESCRIPTION %>
      <div class="description mt-5">
        <h3>Description</h3>
        <p><%= @item.long_description %></p>
      </div>

      <%# REVIEWS %>
      <div class="reviews mt-5" id="reviews">
        <h3 class="d-flex justify-content-between align-items-center ts-4 mb-3">
          Avis des utilisateurs
          <%= link_to "Ajouter une review", new_item_review_path(@item), class: "text-decoration-none fs-6", style: "color: #6f42c1;" %>
        </h3>
      </div>

      <% if @item.reviews.any? %>
        <ul class="list-unstyled">
          <% total_rating = @item.reviews.sum(:rating) %>
          <% average_rating = total_rating / @item.reviews.count if @item.reviews.count > 0 %>
          <% @item.reviews.each do |review| %>
            <h5 class="font-weight-bold">
              <strong><%= review.user.name %> - <%= review.rating %> ‚≠ê</strong>
            </h5>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <p style="margin: 1;">
                <%= review.content %>
                <small> - Il y a <%= time_ago_in_words(review.created_at) %></small>
              </p>
              <% if review.user_id == current_user.id %>
                <%= link_to "‚úñ", review_path(review),
                      data: { turbo_method: :delete, turbo_confirm: "Are you sure you want to delete this review?" },
                      class: "text-danger", style: "text-decoration: none; font-size: 1rem; margin-left: 1rem;" %>
              <% end %>
            </div>
          <% end %>
        </ul>
      <% else %>
        <p>No reviews yet</p>
      <% end %>
    </section>

    <aside class="booking">
      <div class="price"><%= @item.price.round %>‚Ç¨ / jour</div>
      <%= form_with url: new_item_reservation_path(@item), method: :get, local: true do %>
        <div class="form-group mt-3">
          <label for="startDate">Date de d√©but</label>
          <input type="date" name="start_date" class="form-control" id="startDate">
        </div>
        <div class="form-group mt-3">
          <label for="endDate">Date de fin</label>
          <input type="date" name="end_date" class="form-control" id="endDate">
        </div>
        <%= submit_tag "R√©server", class: "btn btn-primary mt-3" %>
      <% end %>
      <div class="summary mt-5">
        <h4>Information importante</h4>

    <p>
      <strong>‚ö†Ô∏è Attention :</strong> Magic Bazaar n‚Äôest pas responsable des incidents magiques li√©s √† l‚Äôutilisation des objets. Soyez prudent !
    </p>
      </div>
    </aside>
     <% if @item.user == current_user %>
        <%= link_to "Supprimer l'objet", item_path(@item), data: { turbo_method: :delete, turbo_confirm: "√ätes-vous s√ªr de vouloir supprimer cet objet ?" }, class: "btn btn-outline-danger", style: "border-radius: 0.5rem;" %>
      <% end %>
  </div>
</main>
